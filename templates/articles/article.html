<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文章详情</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet" media="screen">
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        img {
            max-width: 80%;
            height: auto;
        }
        .comment-reply {
            margin-left: 40px;
            border-left: 2px solid #e9ecef;
            padding-left: 15px;
        }
        .more-replies {
            font-size: 0.875rem;
            color: #6c757d;
            cursor: pointer;
        }
        .more-replies:hover {
            color: #495057;
            text-decoration: underline;
        }
        .comment-actions {
            display: flex;
            gap: 15px;
        }
        .delete-comment {
            color: #dc3545;
            text-decoration: none;
        }
        .delete-comment:hover {
            color: #c82333;
            text-decoration: underline;
        }
    </style>
    {{template "bgc" .}}
</head>

<body>
    <!-- 在 body 开始处添加隐藏的 input 元素 -->
    <input type="hidden" id="current-user-id" value="{{.user_id}}">
    <input type="hidden" id="article-author-id" value="{{.article.UserID}}">
    <div class="container text-center card" style="width: 80%;">
        <div class="card-body">
            {{if .article}}
            <h5 class="card-title">{{.article.Title}}</h5>
            <h6 class="card-subtitle mb-2 text-body-secondary">作者: {{.article.User.Username}}, 发布时间:
                {{.article.UpdatedAt.Format "2006-01-02"}}</h6>
            <div class="card-text">{{.article.Content}}</div>
            {{else}}
            <div class="card-text">暂无数据</div>
            {{end}}

            {{if and .user_id (eq .user_id .article.UserID)}}
            <a href="/articles/{{.article.Id}}/edit"
                class="card-link link-primary link-offset-2 link-underline-opacity-25 link-underline-opacity-100-hover">编辑</a>
            <a href="/articles/{{.article.Id}}" id="delete-link"
                class="card-link link-danger link-offset-2 link-underline-opacity-25 link-underline-opacity-100-hover">删除</a>
            {{end}}
            {{if .article.Category.Name}}
            <a href="{{if .BaseURL}}/{{.BaseURL}}{{end}}/?category={{.article.Category.ID}}"
                class="card-link link-info link-offset-2 link-underline-opacity-25 link-underline-opacity-100-hover">跳转分区：{{.article.Category.Name}}</a>
            {{end}}
            <a href="/{{.BaseURL}}"
                class="card-link link-info link-offset-2 link-underline-opacity-25 link-underline-opacity-100-hover">返回文章列表</a>
        </div>
    </div>
    <div class="container card text-center" style="width: 80%;">
        <div class="card-header">
            <h5 class="mb-0">评论</h5>
        </div>
        <div class="card-body">
            <!-- 评论表单 -->
            {{if .user_id}}
            <form id="comment-form" class="mb-4">
                <input type="hidden" id="article-id" value="{{.article.Id}}">
                <input type="hidden" id="parent-id" value="0">
                <div class="mb-3">
                    <textarea class="form-control" id="comment-content" rows="3" placeholder="写下你的评论..." required></textarea>
                </div>
                <button type="submit" class="btn btn-primary">发表评论</button>
            </form>
            {{else}}
            <div class="alert alert-info">
                请<a href="/login">登录</a>后发表评论
            </div>
            {{end}}
            
            <!-- 评论列表 -->
            <div id="comments-list" class="list-group">
                <!-- 评论将通过JavaScript动态加载 -->
            </div>
        </div>
    </div>
    <script src="/static/js/bootstrap.bundle.js"></script>
    <script>
        // 从隐藏的 input 元素中获取值
        const currentUserId = document.getElementById('current-user-id').value || 0;
        const articleAuthorId = document.getElementById('article-author-id').value || 0;

        const deleteLink = document.getElementById('delete-link');
        if (deleteLink) {
            deleteLink.addEventListener('click', function (e) {
                e.preventDefault(); // 阻止默认的链接跳转

                const url = this.getAttribute('href'); // 获取链接的URL

                if (confirm('确定要删除这篇文章吗？')) {
                    fetch(url, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                            // 如果需要CSRF令牌，可以在这里添加
                            // 'X-CSRF-Token': 'your-csrf-token'
                        }
                    })
                        .then(response => {
                            // 检查响应状态
                            if (!response.ok) {
                                throw new Error(`HTTP错误! 状态: ${response.status}`);
                            }
                            return response.json(); // 解析JSON响应
                        })
                        .then(data => {
                            // 显示成功消息
                            alert(data.message);
                            window.location.href = '/articles'; // 跳转到文章列表
                        })
                        .catch(error => {
                            console.log(error.message);
                            alert("无权操作此文章");
                        });
                }
            });
        }

        // 评论功能
        document.addEventListener('DOMContentLoaded', function() {
            loadComments();
            
            // 提交评论表单
            const commentForm = document.getElementById('comment-form');
            if (commentForm) {
                commentForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const content = document.getElementById('comment-content').value.trim();
                    const articleId = document.getElementById('article-id').value;
                    const parentId = document.getElementById('parent-id').value;
                    
                    if (!content) {
                        alert('评论内容不能为空');
                        return;
                    }
                    
                    submitComment(content, articleId, parentId);
                });
            }
        });
        
        // 加载评论
        function loadComments() {
            const articleId = document.getElementById('article-id').value;
            
            fetch(`/comments/${articleId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        renderComments(data.comments);
                    } else {
                        console.error('加载评论失败:', data.message);
                    }
                })
                .catch(error => {
                    console.error('加载评论时出错:', error);
                });
        }
        
        // 渲染评论
        function renderComments(comments, parentElement = null, level = 0) {
            const commentsList = parentElement || document.getElementById('comments-list');
            
            if (!parentElement) {
                commentsList.innerHTML = '';
            }
            
            if (comments.length === 0 && level === 0) {
                commentsList.innerHTML = '<p class="text-muted">暂无评论，快来发表第一条评论吧！</p>';
                return;
            }
            
            // 如果是二级评论且数量超过1条，默认只显示第一条
            if (level > 0 && comments.length > 1) {
                // 显示第一条评论
                const firstComment = comments[0];
                const commentElement = createCommentElement(firstComment, level);
                commentsList.appendChild(commentElement);
                
                // 如果有回复，递归渲染
                if (firstComment.replies && firstComment.replies.length > 0) {
                    renderComments(firstComment.replies, commentElement.querySelector('.replies-container'), level + 1);
                }
                
                // 添加"展开更多"按钮
                const moreButton = document.createElement('div');
                moreButton.className = 'more-replies mt-2 mb-2';
                moreButton.innerHTML = `<span>展开剩余 ${comments.length - 1} 条回复</span>`;
                moreButton.addEventListener('click', function() {
                    // 移除当前显示的第一条评论和"展开更多"按钮
                    commentsList.innerHTML = '';
                    
                    // 渲染所有评论
                    comments.forEach(comment => {
                        const commentElement = createCommentElement(comment, level);
                        commentsList.appendChild(commentElement);
                        
                        // 如果有回复，递归渲染
                        if (comment.replies && comment.replies.length > 0) {
                            renderComments(comment.replies, commentElement.querySelector('.replies-container'), level + 1);
                        }
                    });
                });
                commentsList.appendChild(moreButton);
            } else {
                // 正常渲染所有评论
                comments.forEach(comment => {
                    const commentElement = createCommentElement(comment, level);
                    commentsList.appendChild(commentElement);
                    
                    // 如果有回复，递归渲染
                    if (comment.replies && comment.replies.length > 0) {
                        renderComments(comment.replies, commentElement.querySelector('.replies-container'), level + 1);
                    }
                });
            }
        }
        
        // 创建评论元素
        function createCommentElement(comment, level) {
            const commentDiv = document.createElement('div');
            commentDiv.className = `comment ${level > 0 ? 'comment-reply' : ''}`;
            
            // 格式化日期
            const commentDate = new Date(comment.created_at).toLocaleString();
            
            // 检查是否有删除权限：文章作者或评论发布者
            const canDelete = currentUserId && 
                (currentUserId == articleAuthorId || currentUserId == comment.user.id);
            
            // 二级评论不显示回复按钮
            const replyButtonHtml = level === 0 ? 
                `<a href="#" class="reply-link link-offset-2 link-underline link-underline-opacity-0 link-underline-opacity-100-hover" data-comment-id="${comment.id}">回复</a>` : 
                '';
            
            // 删除按钮（如果有权限）
            const deleteButtonHtml = canDelete ? 
                `<a href="#" class="delete-comment link-offset-2" data-comment-id="${comment.id}">删除</a>` : 
                '';
            
            commentDiv.innerHTML = `
            <div class="list-group-item">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <strong>${comment.user.username}</strong>
                        <small class="text-muted ms-2">${commentDate}</small>
                    </div>
                </div>
                <p class="mt-2 mb-1">${comment.content}</p>
                <div class="comment-actions">
                    ${replyButtonHtml}
                    ${deleteButtonHtml}
                </div>
                <div class="reply-form" id="reply-form-${comment.id}" style="display: none;">
                    <form class="mt-2">
                        <div class="mb-2">
                            <textarea class="form-control form-control-sm" rows="2" placeholder="回复 ${comment.user.username}..." required></textarea>
                        </div>
                        <div>
                            <button type="submit" class="btn btn-primary btn-sm">提交回复</button>
                            <button type="button" class="btn btn-secondary btn-sm cancel-reply">取消</button>
                        </div>
                    </form>
                </div>
                <div class="replies-container mt-2"></div>
            </div>
            `;
            
            // 只有一级评论才添加回复表单事件
            if (level === 0) {
                const replyLink = commentDiv.querySelector('.reply-link');
                const replyForm = commentDiv.querySelector('.reply-form');
                const cancelBtn = commentDiv.querySelector('.cancel-reply');
                
                if (replyLink) {
                    replyLink.addEventListener('click', function(e) {
                        e.preventDefault();
                        replyForm.style.display = 'block';
                    });
                }
                
                if (cancelBtn) {
                    cancelBtn.addEventListener('click', function() {
                        replyForm.style.display = 'none';
                        replyForm.querySelector('textarea').value = '';
                    });
                }
                
                const replyFormElement = replyForm.querySelector('form');
                replyFormElement.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const content = this.querySelector('textarea').value.trim();
                    const articleId = document.getElementById('article-id').value
                    const parentId = comment.id;
                    
                    if (!content) {
                        alert('回复内容不能为空');
                        return;
                    }
                    submitComment(content, articleId, String(parentId));
                    replyForm.style.display = 'none';
                    this.querySelector('textarea').value = '';
                });
            }
            
            // 添加删除按钮事件
            if (canDelete) {
                const deleteBtn = commentDiv.querySelector('.delete-comment');
                deleteBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (confirm('确定要删除这条评论吗？' + (level === 0 ? '\n注意：删除一级评论会同时删除其所有回复！' : ''))) {
                        deleteComment(comment.id);
                    }
                });
            }
            
            return commentDiv;
        }
        
        // 提交评论
        function submitComment(content, articleId, parentId = 0) {
            fetch('/comments', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    // 如果需要CSRF令牌，可以在这里添加
                    // 'X-CSRF-Token': 'your-csrf-token'
                },
                body: JSON.stringify({
                    content: content,
                    article_id: articleId,
                    parent_id: parentId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('comment-content').value = '';
                    document.getElementById('parent-id').value = '0';
                    loadComments(); // 重新加载所有评论
                } else {
                    alert('评论失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('提交评论时出错:', error);
                alert('提交评论时出错，请重试');
            });
        }
        
        // 删除评论
        function deleteComment(commentId) {
            fetch(`/comments/${commentId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                // 如果需要CSRF令牌，可以在这里添加
                    // 'X-CSRF-Token': 'your-csrf-token'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message || '删除成功');
                    loadComments(); // 重新加载评论
                } else {
                    alert('删除失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('删除评论时出错:', error);
                alert('删除评论时出错，请重试');
            });
        }
    </script>
</body>

</html>