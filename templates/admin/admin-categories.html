<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理员界面</title>
    <link href="/static//css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="d-flex">
    {{template "navbar-admin" .}}
    <main class="flex-grow-1 p-3">
        <div class="container text-center">
            <div class="row">
                <div class="col-auto">
                    <button class="btn btn-success" style="margin: 5px;" data-bs-toggle="modal"
                        data-bs-target="#categoryModal" onclick="setAddMode()">新增类别</button>
                </div>
            </div>
            <div class="row">
                <div class="list-group transparent-list-group">
                    {{range .categories}}
                    <div class="list-group-item">
                        <div class="col">
                            {{.Name}}: {{.Description}}
                        </div>

                        <div class="col">
                            <button class="btn btn-warning" style="margin: 5px;" data-bs-toggle="modal"
                                data-bs-target="#categoryModal"
                                onclick="editCategory('{{.ID}}', '{{.Name}}', '{{.Slug}}', '{{.Description}}')">修改</button>
                            <button class="btn btn-danger" style="margin: 5px;" data-bs-toggle="modal"
                                data-bs-target="#deleteConfirmModal"
                                onclick="confirmDelete('{{.ID}}','{{.Name}}')">删除</button>
                        </div>
                    </div>
                    {{else}}
                    <div class="col">
                        <div class="list-group-item">暂无数据</div>
                    </div>
                    {{end}}
                </div>
            </div>
            <div class="row">
                {{template "pager" .}}
            </div>
        </div>
    
        <!-- 新增/修改类别模态框 -->
        <div class="modal fade" id="categoryModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title" id="modalTitle">新增类别</h4>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="categoryForm">
                            <input type="hidden" id="categoryId" name="id">
                            <div class="mb-3">
                                <label for="categoryName" class="form-label">类别名称</label>
                                <input type="text" class="form-control" id="categoryName" name="name" placeholder="请输入类别名称"
                                    required>
                            </div>
                            <div class="mb-3">
                                <label for="categorySlug" class="form-label">Slug</label>
                                <input type="text" class="form-control" id="categorySlug" name="slug" placeholder="请输入Slug"
                                    required>
                            </div>
                            <div class="mb-3">
                                <label for="categoryDescription" class="form-label">描述</label>
                                <textarea class="form-control" id="categoryDescription" name="description"
                                    placeholder="请输入描述" rows="3"></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                        <button type="button" class="btn btn-primary" onclick="saveCategory()">保存</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 删除确认模态框 -->
        <div class="modal fade" id="deleteConfirmModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title">确认删除</h4>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>确定要删除类别 "<span id="deleteCategoryName"></span>" 吗？此操作不可恢复！</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-danger" onclick="deleteCategory()">确认删除</button>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <script src="/static//js/bootstrap.bundle.js"></script>
    <script>
        let currentDeleteId = null;
        let method = '';

        // 获取模态框实例
        const categoryModal = new bootstrap.Modal(document.getElementById('categoryModal'));
        const deleteConfirmModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));

        // 设置为新增模式
        function setAddMode() {
            document.getElementById('modalTitle').textContent = '新增类别';
            document.getElementById('categoryForm').reset();
            document.getElementById('categoryId').value = '';
            method = 'POST';
        }

        // 编辑类别
        function editCategory(id, name, slug, description) {
            document.getElementById('modalTitle').textContent = '修改类别';
            document.getElementById('categoryId').value = id;
            document.getElementById('categorySlug').value = slug;
            document.getElementById('categoryName').value = name;
            document.getElementById('categoryDescription').value = description;
            method = 'PUT';
            // 显示模态框
            categoryModal.show();
        }

        // 确认删除
        function confirmDelete(id, name) {
            currentDeleteId = id;
            document.getElementById('deleteCategoryName').textContent = name;
            deleteConfirmModal.show();
        }

        // 保存类别（新增或修改）
        function saveCategory() {
            const formData = {
                id: document.getElementById('categoryId').value,
                name: document.getElementById('categoryName').value,
                slug: document.getElementById('categorySlug').value,
                description: document.getElementById('categoryDescription').value
            };

            let url = '/categories';
            if (method === "PUT") {
                url += "/" + formData.id;
            }

            console.log(method, url);

            // 发送AJAX请求到后端
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
                .then(response => {
                    // 检查响应状态
                    if (!response.ok) {
                        throw new Error(`HTTP错误! 状态: ${response.status}`);
                    }
                    return response.json(); // 解析JSON响应
                })
                .then(data => {
                    categoryModal.hide();
                    console.log(data);
                    location.reload(); // 简单刷新页面，你可以优化为局部更新
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('保存失败');
                });
        }

        // 删除类别
        function deleteCategory() {
            if (!currentDeleteId) return;

            fetch('/categories/' + currentDeleteId, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ id: currentDeleteId })
            })
                .then(response => {
                    // 检查响应状态
                    if (!response.ok) {
                        throw new Error(`HTTP错误! 状态: ${response.status}`);
                    }
                    return response.json(); // 解析JSON响应
                })
                .then(data => {
                    console.log(data);
                    deleteConfirmModal.hide();
                    location.reload(); // 简单刷新页面，你可以优化为局部更新
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('删除失败');
                });
        }

        // 模态框事件处理
        document.getElementById('categoryModal').addEventListener('shown.bs.modal', function () {
            document.getElementById('categoryName').focus();
        });

        document.getElementById('deleteConfirmModal').addEventListener('hidden.bs.modal', function () {
            currentDeleteId = null;
        });
    </script>
</body>

</html>